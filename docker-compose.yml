version: "3.9"

services:
  ui:
    build:
      context: .
      dockerfile: apps/ui/Dockerfile
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  balance:
    build:
      context: .
      dockerfile: apps/balance/Dockerfile
    ports:
      - "3002:3002"
      - "50051:50051"
      - "9102:9102"
    environment:
      HTTP_PORT: "3002"
      GRPC_PORT: "50051"
      METRICS_PORT: "9102"
      REDIS_URL: "redis://redis:6379"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    depends_on:
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  keycloak-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.1
    command: ["start-dev", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
    ports:
      - "8080:8080"
    volumes:
      - ./infra/keycloak:/opt/keycloak/data/import
    depends_on:
      - keycloak-db
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    command: ["--config=/etc/otel/collector-config.yaml"]
    volumes:
      - ./infra/otel/collector-config.yaml:/etc/otel/collector-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  prometheus:
    image: prom/prometheus:v2.50.0
    command: ["--config.file=/etc/prometheus/prometheus.yaml"]
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus:/etc/prometheus
    depends_on:
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  grafana:
    image: grafana/grafana:10.3.1
    ports:
      - "3001:3000"
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - ./infra/grafana/dashboards:/etc/grafana/dashboards
    depends_on:
      - prometheus
      - loki
      - tempo-grafana-proxy
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  loki:
    image: grafana/loki:2.9.4
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  promtail:
    image: grafana/promtail:2.9.4
    command: -config.file=/etc/promtail/config.yaml
    volumes:
      - ./infra/promtail/promtail.yaml:/etc/promtail/config.yaml
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    depends_on:
      - loki
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  tempo:
    image: grafana/tempo:2.3.1
    # Tempo defaults to 5MB per trace; long-lived traces (e.g., WS sessions) can exceed this in local dev.
    command: ["-config.file=/etc/tempo.yaml", "-ingester.max-bytes-per-trace=20000000"]
    volumes:
      - ./infra/tempo/tempo.yaml:/etc/tempo.yaml
    ports:
      - "3200:3200"
      - "4317:4317" # otlp grpc
      - "4318:4318" # otlp http
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  tempo-grafana-proxy:
    build:
      context: ./infra/tempo/grafana-proxy
      dockerfile: Dockerfile
    environment:
      TEMPO_URL: "http://tempo:3200"
      PORT: "3200"
    depends_on:
      - tempo
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 2s
      retries: 3

  event-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: event
      POSTGRES_USER: event
      POSTGRES_PASSWORD: event
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U event"]
      interval: 10s
      timeout: 2s
      retries: 3

  event:
    build:
      context: .
      dockerfile: apps/event/Dockerfile
    ports:
      - "50054:50054"
    environment:
      GRPC_PORT: "50054"
      METRICS_PORT: "9104"
      DATABASE_URL: "postgresql://event:event@event-db:5432/event"
      REDIS_URL: "redis://redis:6379"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    depends_on:
      - event-db
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  game:
    build:
      context: .
      dockerfile: apps/game/Dockerfile
    ports:
      - "50053:50053"
    environment:
      PORT: "50053"
      METRICS_PORT: "9105"
      REDIS_URL: "redis://redis:6379"
      BALANCE_SERVICE_ADDR: "balance:50051"
      EVENT_SERVICE_ADDR: "event:50054"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    depends_on:
      - balance
      - event
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  notify:
    build:
      context: .
      dockerfile: apps/notify/Dockerfile
    ports:
      - "50055:50055"
    environment:
      GRPC_PORT: "50055"
      METRICS_PORT: "9105"
      REDIS_URL: "redis://redis:6379"
      VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY}"
      VAPID_PRIVATE_KEY: "${VAPID_PRIVATE_KEY}"
      VAPID_SUBJECT: "${VAPID_SUBJECT}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    depends_on:
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  player-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: player
      POSTGRES_USER: player
      POSTGRES_PASSWORD: player
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U player"]
      interval: 10s
      timeout: 2s
      retries: 3

  player:
    build:
      context: .
      dockerfile: apps/player/Dockerfile
    ports:
      - "50052:50052"
      - "9103:9103"
    environment:
      GRPC_PORT: "50052"
      METRICS_PORT: "9103"
      DATABASE_URL: "postgresql://player:player@player-db:5432/player"
      REDIS_URL: "redis://redis:6379"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    depends_on:
      - player-db
      - redis
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  gateway:
    build:
      context: .
      dockerfile: apps/gateway/Dockerfile
    ports:
      - "4000:4000"
      - "9104:9104"
    environment:
      PORT: "4000"
      METRICS_PORT: "9104"
      HTTP_RATE_LIMIT_MAX: "1000"
      WS_RATE_LIMIT_MAX: "200"
      REDIS_URL: "redis://redis:6379"
      KEYCLOAK_URL: "http://keycloak:8080"
      KEYCLOAK_REALM: "poker-local"
      BALANCE_SERVICE_HTTP_URL: "balance:3002"
      BALANCE_SERVICE_URL: "balance:50051"
      GAME_SERVICE_URL: "game:50053"
      PLAYER_SERVICE_URL: "player:50052"
      EVENT_SERVICE_URL: "event:50054"
      NOTIFY_SERVICE_URL: "notify:50055"
      VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY}"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    depends_on:
      - redis
      - keycloak
      - balance
      - game
      - player
      - event
      - notify
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3
