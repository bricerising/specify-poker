version: "3.9"

services:
  ui:
    build:
      context: .
      dockerfile: apps/ui/Dockerfile
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    ports:
      - "4000:4000"
    environment:
      PORT: "4000"
      KEYCLOAK_URL: "http://keycloak:8080"
      KEYCLOAK_REALM: "poker-local"
      REDIS_URL: "redis://redis:6379"
      UI_BASE_URL: "http://localhost:3000"
      VAPID_PUBLIC_KEY: "${VAPID_PUBLIC_KEY}"
      VAPID_PRIVATE_KEY: "${VAPID_PRIVATE_KEY}"
      VAPID_SUBJECT: "${VAPID_SUBJECT}"
    depends_on:
      - keycloak
      - otel-collector
      - redis
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  keycloak-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.1
    command: ["start-dev", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-db
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
    ports:
      - "8080:8080"
    volumes:
      - ./infra/keycloak:/opt/keycloak/data/import
    depends_on:
      - keycloak-db
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  otel-collector:
    image: otel/opentelemetry-collector:0.96.0
    command: ["--config=/etc/otel/collector-config.yaml"]
    volumes:
      - ./infra/otel/collector-config.yaml:/etc/otel/collector-config.yaml
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  prometheus:
    image: prom/prometheus:v2.50.0
    command: ["--config.file=/etc/prometheus/prometheus.yaml"]
    ports:
      - "9090:9090"
    volumes:
      - ./infra/prometheus:/etc/prometheus
    depends_on:
      - otel-collector
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  grafana:
    image: grafana/grafana:10.3.1
    ports:
      - "3001:3000"
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - ./infra/grafana/dashboards:/etc/grafana/dashboards
    depends_on:
      - prometheus
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 10s
      timeout: 2s
      retries: 3

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 2s
      retries: 3
