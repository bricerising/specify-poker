openapi: 3.0.3
info:
  title: Play-Money Poker MVP API
  version: 0.1.0
servers:
  - url: http://localhost:4000

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorResponse:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
    UserProfile:
      type: object
      required: [userId, nickname, avatarUrl, stats, friends]
      properties:
        userId:
          type: string
        nickname:
          type: string
        avatarUrl:
          type: string
          nullable: true
        stats:
          type: object
          required: [handsPlayed, wins]
          properties:
            handsPlayed:
              type: integer
            wins:
              type: integer
        friends:
          type: array
          items:
            type: string
    TableConfig:
      type: object
      required: [smallBlind, bigBlind, maxPlayers, startingStack, bettingStructure]
      properties:
        smallBlind:
          type: integer
        bigBlind:
          type: integer
        ante:
          type: integer
          nullable: true
        maxPlayers:
          type: integer
        startingStack:
          type: integer
        bettingStructure:
          type: string
          enum: [NoLimit]
    TableCreateConfig:
      type: object
      required: [smallBlind, bigBlind, maxPlayers, startingStack]
      properties:
        smallBlind:
          type: integer
        bigBlind:
          type: integer
        ante:
          type: integer
          nullable: true
        maxPlayers:
          type: integer
        startingStack:
          type: integer
    TableSummary:
      type: object
      required: [tableId, name, ownerId, config, seatsTaken, occupiedSeatIds, inProgress, spectatorCount]
      properties:
        tableId:
          type: string
        name:
          type: string
        ownerId:
          type: string
        config:
          $ref: '#/components/schemas/TableConfig'
        seatsTaken:
          type: integer
        occupiedSeatIds:
          type: array
          items:
            type: integer
        inProgress:
          type: boolean
        spectatorCount:
          type: integer
    TableSeat:
      type: object
      required: [seatId, userId, stack, status]
      properties:
        seatId:
          type: integer
        userId:
          type: string
          nullable: true
        stack:
          type: integer
        status:
          type: string
          enum: [empty, active, folded, all_in, disconnected]
    SpectatorView:
      type: object
      required: [userId, status]
      properties:
        userId:
          type: string
        nickname:
          type: string
          nullable: true
        status:
          type: string
          enum: [active, disconnected]
    TableState:
      type: object
      required: [tableId, name, ownerId, config, seats, spectators, status, hand, version]
      properties:
        tableId:
          type: string
        name:
          type: string
        ownerId:
          type: string
        config:
          $ref: '#/components/schemas/TableConfig'
        seats:
          type: array
          items:
            $ref: '#/components/schemas/TableSeat'
        spectators:
          type: array
          items:
            $ref: '#/components/schemas/SpectatorView'
        status:
          type: string
          enum: [lobby, in_hand]
        hand:
          allOf:
            - $ref: '#/components/schemas/HandState'
          nullable: true
        version:
          type: integer
    TableCreateRequest:
      type: object
      required: [name, config]
      properties:
        name:
          type: string
        config:
          $ref: '#/components/schemas/TableCreateConfig'
    TableJoinRequest:
      type: object
      required: [seatId]
      properties:
        seatId:
          type: integer
          description: Zero-based seat index. Invalid seat ids are rejected with a 409 error.
    TableJoinResponse:
      type: object
      required: [tableId, seatId, wsUrl]
      properties:
        tableId:
          type: string
        seatId:
          type: integer
        wsUrl:
          type: string
    FriendsList:
      type: object
      required: [friends]
      properties:
        friends:
          type: array
          items:
            type: string
    ModerationRequest:
      type: object
      required: [seatId]
      properties:
        seatId:
          type: integer
          minimum: 0
          maximum: 8
    PushSubscription:
      type: object
      required: [endpoint]
      properties:
        endpoint:
          type: string
        keys:
          type: object
          properties:
            p256dh:
              type: string
            auth:
              type: string
    VapidPublicKey:
      type: object
      required: [publicKey]
      properties:
        publicKey:
          type: string
    Pot:
      type: object
      required: [amount, eligibleSeatIds]
      properties:
        amount:
          type: integer
        eligibleSeatIds:
          type: array
          items:
            type: integer
    HandState:
      type: object
      required:
        [
          handId,
          tableId,
          buttonSeat,
          smallBlindSeat,
          bigBlindSeat,
          communityCards,
          pots,
          currentStreet,
          currentTurnSeat,
          currentBet,
          minRaise,
          raiseCapped,
          roundContributions,
          totalContributions,
          actedSeats,
          actionTimerDeadline,
          startedAt,
          endedAt,
          bigBlind
        ]
      properties:
        handId:
          type: string
        tableId:
          type: string
        buttonSeat:
          type: integer
        smallBlindSeat:
          type: integer
        bigBlindSeat:
          type: integer
        communityCards:
          type: array
          items:
            type: string
        pots:
          type: array
          items:
            $ref: '#/components/schemas/Pot'
        currentStreet:
          type: string
          enum: [preflop, flop, turn, river, showdown, ended]
        currentTurnSeat:
          type: integer
        currentBet:
          type: integer
        minRaise:
          type: integer
        raiseCapped:
          type: boolean
        roundContributions:
          type: object
          additionalProperties:
            type: integer
        totalContributions:
          type: object
          additionalProperties:
            type: integer
        actedSeats:
          type: array
          items:
            type: integer
        actionTimerDeadline:
          type: string
          nullable: true
        startedAt:
          type: string
        endedAt:
          type: string
          nullable: true
        bigBlind:
          type: integer
        winners:
          type: array
          items:
            type: integer
        holeCards:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
        deck:
          type: array
          items:
            type: string
    HandEvent:
      type: object
      required: [eventId, handId, type, payload, ts]
      properties:
        eventId:
          type: string
        handId:
          type: string
        type:
          type: string
        payload:
          type: object
        ts:
          type: string
    AuditResponse:
      type: object
      required: [handId, events, replay]
      properties:
        handId:
          type: string
        events:
          type: array
          items:
            $ref: '#/components/schemas/HandEvent'
        replay:
          allOf:
            - $ref: '#/components/schemas/HandState'
          nullable: true

security:
  - bearerAuth: []

paths:
  /api/health:
    get:
      summary: Health check
      security: []
      responses:
        '200':
          description: OK

  /metrics:
    get:
      summary: Prometheus metrics
      security: []
      responses:
        '200':
          description: Metrics payload
          content:
            text/plain:
              schema:
                type: string

  /api/push/vapid:
    get:
      summary: Get VAPID public key
      responses:
        '200':
          description: VAPID public key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VapidPublicKey'
        '503':
          description: VAPID missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/push/subscribe:
    post:
      summary: Register push subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PushSubscription'
      responses:
        '204':
          description: Subscription stored
        '400':
          description: Invalid subscription
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Remove push subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [endpoint]
              properties:
                endpoint:
                  type: string
      responses:
        '204':
          description: Subscription removed
        '400':
          description: Invalid subscription
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/me:
    get:
      summary: Get current user profile
      responses:
        '200':
          description: Profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/profile:
    post:
      summary: Update nickname and avatar
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nickname:
                  type: string
                avatarUrl:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/friends:
    get:
      summary: List friends
      responses:
        '200':
          description: Friends list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FriendsList'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update friends list
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FriendsList'
      responses:
        '200':
          description: Updated friends list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FriendsList'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tables:
    get:
      summary: List lobby tables
      responses:
        '200':
          description: Tables list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TableSummary'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      summary: Create table
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TableCreateRequest'
      responses:
        '201':
          description: Table created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableSummary'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tables/{tableId}/join:
    post:
      summary: Join a seat at a table
      parameters:
        - name: tableId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TableJoinRequest'
      responses:
        '200':
          description: Join result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TableJoinResponse'
        '400':
          description: Validation error (seatId missing or non-integer)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Seat unavailable, already seated, or table missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tables/{tableId}/leave:
    post:
      summary: Leave a table
      parameters:
        - name: tableId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Left table
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not seated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tables/{tableId}/moderation/kick:
    post:
      summary: Kick a player (owner only)
      parameters:
        - name: tableId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModerationRequest'
      responses:
        '200':
          description: Player kicked
          content:
            application/json:
              schema:
                type: object
                required: [tableId, seatId, userId, action, tableState]
                properties:
                  tableId:
                    type: string
                  seatId:
                    type: integer
                  userId:
                    type: string
                  action:
                    type: string
                    enum: [kick]
                  tableState:
                    $ref: '#/components/schemas/TableState'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Table or seat not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Unable to kick
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/tables/{tableId}/moderation/mute:
    post:
      summary: Mute a player (owner only)
      parameters:
        - name: tableId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModerationRequest'
      responses:
        '200':
          description: Player muted
          content:
            application/json:
              schema:
                type: object
                required: [tableId, seatId, userId, action]
                properties:
                  tableId:
                    type: string
                  seatId:
                    type: integer
                  userId:
                    type: string
                  action:
                    type: string
                    enum: [mute]
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Table or seat not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/audit/{handId}:
    get:
      summary: Fetch redacted hand events and replay snapshot
      parameters:
        - name: handId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Audit payload (holeCards and deck are redacted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
